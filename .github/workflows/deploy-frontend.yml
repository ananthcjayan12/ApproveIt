name: Deploy Frontend to Cloudflare Pages

on:
  push:
    branches:
      - main      # development (used as STG)
      - prod      # production environment
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - development
          - production

env:
  PROJECT_NAME: approveit

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy Frontend to Cloudflare Pages
    permissions:
      contents: read
      deployments: write
    # Set environment based on branch or manual input
    environment: ${{ github.event.inputs.environment || (github.ref_name == 'prod' && 'production') || 'development' }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine Environment
        id: env
        run: |
          ENV_NAME="${{ github.event.inputs.environment || (github.ref_name == 'prod' && 'production') || 'development' }}"
          echo "name=${ENV_NAME}" >> $GITHUB_OUTPUT
          
          # Set project name with environment suffix
          if [ "$ENV_NAME" = "production" ]; then
            echo "project=${PROJECT_NAME}" >> $GITHUB_OUTPUT
          else
            echo "project=${PROJECT_NAME}-${ENV_NAME}" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Validate required frontend env
        run: |
          if [ -z "${{ secrets.VITE_WORKER_URL }}" ]; then
            echo "Missing required secret: VITE_WORKER_URL"
            exit 1
          fi

      - name: Build Frontend
        working-directory: ./frontend
        run: npm run build
        env:
          NODE_ENV: production
          VITE_WORKER_URL: ${{ secrets.VITE_WORKER_URL }}
          VITE_MONDAY_CLIENT_ID: ${{ secrets.VITE_MONDAY_CLIENT_ID }}
          VITE_ENVIRONMENT: ${{ steps.env.outputs.name }}

      - name: Create Cloudflare Pages project if not exists
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages project create ${{ steps.env.outputs.project }} --production-branch=prod
        continue-on-error: true  # Will fail if project already exists, that's OK

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        id: deploy
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy frontend/dist --project-name=${{ steps.env.outputs.project }} --branch=${{ github.ref_name }}

      - name: Print Deployment URL
        run: |
          echo "üöÄ Frontend deployed to Cloudflare Pages!"
          echo "üì¶ Environment: ${{ steps.env.outputs.name }}"
          echo "üåø Branch: ${{ github.ref_name }}"
          echo "üìÅ Project: ${{ steps.env.outputs.project }}"
