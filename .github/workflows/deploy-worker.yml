name: Deploy Cloudflare Worker

on:
  push:
    branches:
      - main      # dev environment
      - staging   # staging environment
      - prod      # production environment
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - development
          - staging
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy Worker
    permissions:
      contents: read
    # Set environment based on branch or manual input
    environment: ${{ github.event.inputs.environment || (github.ref_name == 'prod' && 'production') || (github.ref_name == 'staging' && 'staging') || 'development' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine Wrangler Environment
        id: env
        run: |
          ENV_NAME="${{ github.event.inputs.environment || (github.ref_name == 'prod' && 'production') || (github.ref_name == 'staging' && 'staging') || 'development' }}"
          echo "name=${ENV_NAME}" >> $GITHUB_OUTPUT
          
          # Set wrangler --env flag (empty for dev, --env staging/production for others)
          if [ "$ENV_NAME" = "development" ]; then
            echo "flag=" >> $GITHUB_OUTPUT
            echo "db=approveit-db-dev" >> $GITHUB_OUTPUT
          elif [ "$ENV_NAME" = "staging" ]; then
            echo "flag=--env staging" >> $GITHUB_OUTPUT
            echo "db=approveit-db-staging" >> $GITHUB_OUTPUT
          else
            echo "flag=--env production" >> $GITHUB_OUTPUT
            echo "db=approveit-db-production" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Typecheck
        run: npm run typecheck || npx tsc --noEmit

      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.MONDAY_CLIENT_SECRET }}" ]; then
            echo "Missing required secret: MONDAY_CLIENT_SECRET"
            exit 1
          fi
          if [ -z "${{ secrets.MONDAY_SIGNING_SECRET }}" ]; then
            echo "Missing required secret: MONDAY_SIGNING_SECRET"
            exit 1
          fi

      - name: Set Worker Secrets
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "${{ secrets.MONDAY_CLIENT_SECRET }}" | npx wrangler secret put MONDAY_CLIENT_SECRET ${{ steps.env.outputs.flag }}
          echo "${{ secrets.MONDAY_SIGNING_SECRET }}" | npx wrangler secret put MONDAY_SIGNING_SECRET ${{ steps.env.outputs.flag }}
          if [ -n "${{ secrets.JWT_SECRET }}" ]; then
            echo "${{ secrets.JWT_SECRET }}" | npx wrangler secret put JWT_SECRET ${{ steps.env.outputs.flag }}
          fi

      - name: Run D1 Migrations
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: d1 execute ${{ steps.env.outputs.db }} --file=./schema.sql --remote

      - name: Deploy Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: '3'
          command: deploy ${{ steps.env.outputs.flag }}

      - name: Print Deployment Info
        run: |
          echo "ðŸš€ Worker deployed to ${{ steps.env.outputs.name }} environment!"
          echo "ðŸ“¦ Environment: ${{ steps.env.outputs.name }}"
          echo "ðŸŒ¿ Branch: ${{ github.ref_name }}"